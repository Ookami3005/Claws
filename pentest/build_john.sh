#!/usr/bin/bash

# +++++++++++++++
# - Autor: Ookami
# - Versión: 1.0
# +++++++++++++++

# *********************************************************************************************************
# Función auxiliar que compila los scripts extra de John desde el repositorio oficial
#
# - Param: Se espera que reciba una ruta a una carpeta donde se instalarán los scripts adicionales de John.
# *********************************************************************************************************

build_john () {

    # Pedimos un argumento, de lo contrario retornamos error
    if [[ $# -ne 1 ]] ; then
        return 1
    fi

    # Definimos el gestor de paquetes que se va a utilizar
    pac_man=""
    command -v dnf5 > /dev/null && pac_man=dnf5 || pac_man=dnf

    # -------------------------------
    # Dependencias de John The Reaper
    # -------------------------------

    john_deps=(git make gcc openssl-devel yasm gmp-devel libpcap-devel bzip2-devel)

    # ------------
    # Preparativos
    # ------------

    echo -e "Instalando dependencias de John...\n"

    # Instalamos las dependencias
    sudo $pac_man install -y "${john_deps[@]}"

    clear

    # Clonado del repo oficial
    cd "$1" || return 1
    echo -e "Clonando John del repositorio oficial...\n"
    git clone https://github.com/openwall/john -b bleeding-jumbo "$1/john" || return 1
    clear

    # -----------
    # Compilación
    # -----------

    # Realizamos la compilación
    echo -e "Compilando John...\n"
    cd "$1/john/src" || return 1
    ./configure > /dev/null && make -s clean /dev/null clean && make -sj4 > /dev/null
    clear

    # --------------------------------
    # Configuración de los ejecutables
    # --------------------------------

    echo -e "Extrayendo scripts...\n"

    # Generamos un enlace simbólico (en caso de no tenerlo) por temas de compatibilidad con los scripts
    command -v python > /dev/null || sudo ln -sv /usr/bin/python3 /sbin/python > /dev/null

    # Definimos la carpeta donde almacenaremos los ejecutables
    mkdir -p "$HOME/.local"
    mkdir -p "$HOME/.local/bin"
    mkdir -p "$HOME/.local/bin/2john"

    # Transferimos los ejecutables
    cd "$1/john/run" || return 1
    for item in *{2,to}john* ; do
        dest=$(cut -d "." -f 1 <<< "$item")
        cp "$item" "${HOME}/.local/bin/2john/$dest"
    done

    echo -e "Por favor añada al PATH la carpeta '${HOME}/.local/bin/2john'...\n"

}
