#!/usr/bin/env bash

# +++++++++++++++
# - Autor: Ookami
# - Hackers Fight Club
# - Versión: 2.5
# +++++++++++++++

# *********************************************************************************************************
# Función auxiliar que compila los scripts extra de John desde el repositorio oficial
#
# - Param: Se espera que reciba una ruta a una carpeta donde se instalarán los scripts adicionales de John.
# *********************************************************************************************************

build_john () {

    # Pedimos un argumento, de lo contrario retornamos error
    if [[ $# -ne 1 ]] ; then
        echo "Se espera un argumento: build_john <dir>"
        return 1
    fi

    # Definimos el gestor de paquetes que se va a utilizar
    pac_man="dnf"

    # -------------------------------
    # Dependencias de John The Reaper
    # -------------------------------

    john_deps=(git make gcc openssl-devel yasm gmp-devel libpcap-devel bzip2-devel)

    # ------------
    # Preparativos
    # ------------

    echo -e "Instalando dependencias de John...\n"

    # Instalamos las dependencias
    sudo $pac_man install -y "${john_deps[@]}"

    clear

    # Clonado del repo oficial
    cd "$1" || return 1
    echo -e "Clonando John del repositorio oficial...\n"
    sleep 2
    git clone https://github.com/openwall/john -b bleeding-jumbo "john" || return 1
    clear

    # -----------
    # Compilación
    # -----------

    # Realizamos la compilación
    echo -e "Comenzando la compilación de John...\n"
    sleep 2
    cd "john/src" || return 1
    ./configure && make -s clean && make -sj4
    clear

    # --------------------------------
    # Configuración de los ejecutables
    # --------------------------------

    echo -e "\nComenzando configuración...\n"

    # Generamos un enlace simbólico (en caso de no tenerlo) por temas de compatibilidad con los scripts
    command -v python > /dev/null || sudo ln -sf /usr/bin/python3 /sbin/python > /dev/null

    cd "../run" || return 1

    for script in *{2,to}john* ; do
        name=$(echo "$script" | cut -d . -f 1)
        sudo ln -sf "$(pwd)/$script" "/usr/local/bin/$name"
    done

    # Definición de alias
    rc_file=""
    if echo "$SHELL" | grep -q zsh ; then
        rc_file=".zshrc"
    elif echo "$SHELL" | grep -q bash ; then
        rc_file=".bashrc"
    else
        echo "Define un alias john para $(pwd)/john y listo :)"
        return 0
    fi

    echo "alias john='$(pwd)/john'" >> "${HOME}/$rc_file"
    source "${HOME}/$rc_file"
    echo "Listo :)"

    cd || return 1
}
