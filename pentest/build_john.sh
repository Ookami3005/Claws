#!/usr/bin/bash

# +++++++++++++++
# - Autor: Ookami
# - Versión: 2.0
# +++++++++++++++

# *********************************************************************************************************
# Función auxiliar que compila los scripts extra de John desde el repositorio oficial
#
# - Param: Se espera que reciba una ruta a una carpeta donde se instalarán los scripts adicionales de John.
# *********************************************************************************************************

build_john () {

    # Pedimos un argumento, de lo contrario retornamos error
    if [[ $# -ne 1 ]] ; then
        "Se espera un argumento: build_john /ruta/carpeta"
        return 1
    fi

    # Definimos el gestor de paquetes que se va a utilizar
    pac_man=""
    command -v nala > /dev/null && pac_man=nala || pac_man=apt

    # -------------------------------
    # Dependencias de John The Reaper
    # -------------------------------

    john_deps=(git build-essential libssl-dev zlib1g-dev yasm pkg-config libgmp-dev libpcap-dev libbz2-dev)

    # ------------
    # Preparativos
    # ------------

    echo -e "Instalando dependencias de John...\n"
    sleep 2

    # Instalamos las dependencias
    sudo $pac_man install -y "${john_deps[@]}"

    # Si tienes una GPU AMD, te recomiendo descomentar la siguiente línea:
    # sudo $pac_man install -y ocl-icd-opencl-dev opencl-headers fglrx-dev

    # Lo mismo va para usuarios de NVIDIA:
    # sudo $pac_man install -y nvidia-opencl-dev

    clear

    # Clonado del repo oficial
    cd "$1" || return 1
    echo -e "Clonando John del repositorio oficial...\n"
    sleep 2
    git clone https://github.com/openwall/john -b bleeding-jumbo john || return 1
    clear

    # -----------
    # Compilación
    # -----------

    # Realizamos la compilación
    echo -e "Compilando John...\n"
    sleep 2
    cd "john/src" || return 1
    ./configure && make -s clean && make -sj4
    clear

    # --------------------------------
    # Configuración de los ejecutables
    # --------------------------------

    echo -e "Extrayendo scripts...\n"
    sleep 2

    # Generamos un enlace simbólico (en caso de no tenerlo) por temas de compatibilidad con los scripts
    command -v python > /dev/null || sudo ln -sv /usr/bin/python3 /sbin/python > /dev/null

    # Transferimos los ejecutables
    cd "../run" || return 1
    for item in *{2,to}john* ; do
        dest=$(echo "$item" | cut -d '.' -f 1)
        sudo ln -sf "$(pwd)/$item" "/usr/local/bin/$dest"
    done

    # Definición de alias
    rc_file=""
    if echo "$SHELL" | grep -q zsh ; then
        rc_file=".zshrc"
    elif echo "$SHELL" | grep -q bash ; then
        rc_file=".bashrc"
    else
        echo "Define un alias john para $(pwd)/john y listo :)"
        return 0
    fi
    echo "alias john='$(pwd)/john'" >> "${HOME}/$rc_file"
    source "${HOME}/$rc_file"
    echo "Listo :)"

    cd || return 1
}
