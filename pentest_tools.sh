#!/usr/bin/bash
# Script que automatiza la instalación de las herramientas
# que más utilizo en el Hacking Fight Club

# -------
# Imports
# -------

# shellcheck source=pentest/build_john.sh
source pentest/build_john.sh

# shellcheck source=pentest/setup_sqlmap.sh
source pentest/setup_sqlmap.sh

# ------------
# Preparativos
# ------------

# Indicamos que se espera una instrucción
if [[ $# -ne 1 ]] ; then
    echo "Error: No se recibio una instrucción"
    exit 1
fi

# Desplegamos mensaje de ayuda
if [[ $1 == "--help" ]] || [[ $1 == "-h" ]] ; then
    echo -e "Modo de empleo: ./pentest_tools [install|remove]\n\nInstala (o remueve) herramientas básicas y utiles para Pentesting"
    exit 0
fi

# Revisamos la instrucción dada es válida
if [[ $1 != "install" ]] && [[ $1 != "remove" ]] ; then
    echo "Error: Argumento incorrecto"
    exit 1
fi

pac_man=""

# Definimos a Nala como herramienta predeterminada para instalar los paquetes
command -v nala > /dev/null && pac_man=nala || pac_man=apt

# ------------------------
# Herramientas principales
# ------------------------

tools=(git john nmap ffuf hydra gobuster)

# ----
# MAIN
# ----

# Instalamos las herramientas principales del repositorio
sudo $pac_man "$1" -y "${tools[@]}"

if [[ $1 = "install" ]]; then

    # Configuramos sqlmap
    setup_sqlmap

    echo -e "\n"

    # Compilamos scripts adicionales de John
    build_john "$(mktemp -d)"

else

    # Destruimos los Scripts auxiliares de John
    sudo rm -rf "${HOME}/.local/bin/2john"

    # Destruimos el directorio y el enlace simbólico de sqlmap
    sudo rm -rf "${HOME}/.local/bin/sqlmap-dev"
    sudo rm /usr/local/bin/sqlmap

    echo "Listo!"

fi